const{app:app,Menu:Menu,BrowserWindow:BrowserWindow,webContents:webContents,ipcMain:ipcMain}=require("electron"),path=require("path"),url=require("url"),fs=require("fs"),bluebird=require("bluebird"),Config=require("electron-config"),config=new Config,menuConfigFn=require("./menu.config");let mainWindow;function createWindow(){let e={show:!1,frame:!1};Object.assign(e,config.get("winBounds")),mainWindow=new BrowserWindow(e);const n=menuConfigFn(),i=Menu.buildFromTemplate(n);Menu.setApplicationMenu(i),mainWindow.loadURL(url.format({pathname:path.join(__dirname,"index.html"),protocol:"file:",slashes:!0})),mainWindow.once("ready-to-show",mainWindow.show),mainWindow.on("close",()=>{config.set("winBounds",mainWindow.getBounds())}),mainWindow.on("closed",function(){mainWindow=null}),mainWindow.webContents.on("new-window",function(e,n,i,o,a,t){const s=webContents.getAllWebContents(),r=mainWindow.getBounds();a.width=r.width,a.height=r.height,a.x=r.x,a.y=r.y,e.preventDefault();const d=s.filter(e=>e.getURL()===n);if(d.length>0)d[0].focus();else{let e=new BrowserWindow({frame:!0,show:!1});e.once("ready-to-show",e.show),e.on("closed",function(){e=null}),e.loadURL(n),e.webContents.on("did-finish-load",function(e){!async function(){let n=e.sender,i=await bluebird.promisify(fs.readFile)(path.join(path.join(__dirname,"host"),"host_impl.js"));await n.executeJavaScript(String(i))}()})}})}ipcMain.on("min",e=>mainWindow.minimize()),ipcMain.on("max",e=>{mainWindow.isFullScreen()?mainWindow.setFullScreen(!1):mainWindow.setFullScreen(!0)}),ipcMain.on("close",e=>{mainWindow.close()});var filepathOfURL=new Map;ipcMain.on("host_impl",(e,n)=>{let i=JSON.parse(n);if("save"==i.method){const{dialog:n}=require("electron");n.showSaveDialog({defaultPath:i.params[0]},n=>{if(n){fs.createWriteStream(n).end(),filepathOfURL.set(i.params[0],n),e.sender.send("host_impl_callback",JSON.stringify({method:"savedURL",params:i.params}))}else e.sender.send("host_impl_callback",JSON.stringify({method:"canceledSaveURL",params:[i.params[0]]}))})}if("append"==i.method){let n=filepathOfURL.get(i.params[0]);n?fs.appendFile(n,i.params[1],n=>{e.sender.send("host_impl_callback",JSON.stringify({method:"appendedToURL",params:[i.params[0]]}))}):e.sender.send("host_impl_callback",JSON.stringify({method:"canceledSaveURL",params:[i.params[0]]}))}if("copyText"==i.method){const{clipboard:e}=require("electron");e.writeText(i.params[0])}}),app.on("ready",createWindow),app.on("window-all-closed",function(){"darwin"!==process.platform&&app.quit()}),app.on("activate",function(){null===mainWindow&&createWindow()});